#!/usr/bin/env ruby

require 'pkgforge'
require 'mercenary'

FILE_NAME = '.pkgforge'.freeze

def add_common_opts(cmd)
  # rubocop:disable Metrics/LineLength
  cmd.option :directory, '-d DIR', '--directory DIR', 'Change to directory before loading'
  # rubocop:enable Metrics/LineLength
end

def run_on_file(options)
  options[:directory] ||= '.'
  Dir.chdir(options[:directory]) do
    raise("No #{FILE_NAME} file") unless File.exist? FILE_NAME
    forge = PkgForge.load_from_file
    yield forge
  end
end

Mercenary.program(:pkgforge) do |p|
  p.version PkgForge::VERSION
  p.description 'DSL engine for building Arch packages'
  p.syntax 'pkgforge <subcommand> [options]'

  p.command(:build) do |c|
    c.syntax 'build [options]'
    c.description 'Build the package'
    add_common_opts(c)

    c.action do |_, options|
      run_on_file(options) do |forge|
        forge.build!
        forge.test!
        forge.push!
      end
    end
  end

  p.command(:info) do |c|
    c.syntax 'info [options]'
    c.description 'Print package info'
    add_common_opts(c)

    c.action do |_, options|
      run_on_file(options) do |forge|
        puts "name: #{forge.name}"
      end
    end
  end
end
